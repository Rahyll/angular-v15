<div class="nxt-dropdown-container" 
     [class.disabled]="isDisabled"
     [class.open]="isOpen"
     [class.required]="currentRequired"
     [class.multiple]="currentMultiple">
  
  <!-- Custom Trigger (if provided) -->
  <div *ngIf="hasCustomTrigger" class="nxt-dropdown-custom-trigger-wrapper">
    <ng-content select="nxt-dropdown-trigger"></ng-content>
  </div>
  
  <!-- Default Trigger (if no custom trigger provided) -->
  <div class="nxt-dropdown-trigger" 
       *ngIf="!hasCustomTrigger"
       (click)="toggleDropdown()"
       (keydown)="onKeyDown($event)"
       tabindex="0"
       role="combobox"
       [attr.aria-expanded]="isOpen"
       [attr.aria-haspopup]="true"
       [attr.aria-label]="currentPlaceholder">
    
    <div class="nxt-dropdown-value">
      <div class="nxt-dropdown-placeholder" *ngIf="(currentConfirmation && currentMultiple ? pendingOptions : selectedOptions).length === 0">
        {{ currentPlaceholder }}
      </div>
      
      <div class="nxt-dropdown-selected" *ngIf="(confirmation && multiple ? pendingOptions : selectedOptions).length > 0">
        <div class="nxt-dropdown-single" *ngIf="!multiple">
          {{ getDisplayText() }}
        </div>
        
        <div class="nxt-dropdown-multiple" *ngIf="currentMultiple">
          <div class="nxt-dropdown-text">
            {{ currentConfirmation && currentMultiple ? getPendingDisplayText() : getDisplayText() }}
          </div>
        </div>
      </div>
    </div>
    
    <div class="nxt-dropdown-arrow">
      <!-- Down Caret Icon -->
      <svg *ngIf="currentIconType === 'caret'" width="12" height="12" viewBox="0 0 12 12" fill="none">
        <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      
      <!-- Down Arrow Icon -->
      <svg *ngIf="currentIconType === 'arrow'" width="12" height="12" viewBox="0 0 12 12" fill="none">
        <path d="M6 2L6 10M6 10L3 7M6 10L9 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      
      <!-- Sharp Cornered Down Caret Icon -->
      <svg *ngIf="currentIconType === 'sharp-caret'" width="12" height="12" viewBox="0 0 12 12" fill="none">
        <polygon points="3,4.5 6,7.5 9,4.5" fill="currentColor"/>
      </svg>
      
      <!-- Inverted Triangle Icon -->
      <svg *ngIf="currentIconType === 'inverted-triangle'" width="12" height="12" viewBox="0 0 12 12" fill="none">
        <polygon points="2,3 6,9 10,3" fill="currentColor"/>
      </svg>
    </div>
  </div>
  
  <div class="nxt-dropdown-dropdown" 
       *ngIf="isOpen"
       [class]="currentPanelClass"
       [class.confirmation-mode]="currentConfirmation && currentMultiple">
    
    <!-- Search Input -->
    <div class="nxt-dropdown-search" *ngIf="currentSearchable && showSearchInput">
      <div class="nxt-dropdown-search-container">
        <input type="text"
               class="nxt-dropdown-search-input"
               [placeholder]="currentSearchPlaceholder"
               [value]="searchText"
               (input)="onSearchInput($event)"
               (keydown)="onSearchKeyDown($event)"
               autocomplete="off"
               spellcheck="false">
        <button type="button" 
                class="nxt-dropdown-search-clear"
                *ngIf="searchText"
                (click)="clearSearch()"
                aria-label="Clear search">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M9 3L3 9M3 3L9 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="nxt-dropdown-options">
      <!-- Select All Option (only for multiple selection) -->
      <div class="nxt-dropdown-option nxt-dropdown-all-option"
           *ngIf="currentMultiple && filteredOptions.length > 0"
           [class.selected]="isAllSelected()"
           [class.partially-selected]="isPartiallySelected()"
           (click)="selectAll()"
           role="option"
           [attr.aria-selected]="isAllSelected()">
        
        <div class="nxt-dropdown-option-content">
          <div class="nxt-dropdown-option-checkbox">
            <div class="nxt-dropdown-checkbox" 
                 [class.checked]="isAllSelected()"
                 [class.partially]="isPartiallySelected()">
              <svg *ngIf="isAllSelected()" width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M2 6L5 9L10 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <svg *ngIf="isPartiallySelected()" width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M3 6H9" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
          </div>
          
          <div class="nxt-dropdown-option-label">
            <strong>Select All</strong>
          </div>
        </div>
      </div>

      <!-- Divider after Select All -->
      <div class="nxt-dropdown-divider" *ngIf="currentMultiple && filteredOptions.length > 0"></div>
      
      <!-- Regular Options -->
      <div class="nxt-dropdown-option"
           *ngFor="let option of filteredOptions; trackBy: trackByValue"
           [class.selected]="isOptionSelected(option)"
           [class.disabled]="option.disabled"
           (click)="selectOption(option)"
           role="option"
           [attr.aria-selected]="isOptionSelected(option)">
        
        <div class="nxt-dropdown-option-content">
          <div class="nxt-dropdown-option-checkbox" *ngIf="currentMultiple">
            <div class="nxt-dropdown-checkbox" [class.checked]="isOptionSelected(option)">
              <svg *ngIf="isOptionSelected(option)" width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M2 6L5 9L10 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          
          <div class="nxt-dropdown-option-label">
            {{ option.label }}
          </div>
          
          <div class="nxt-dropdown-option-description" *ngIf="option.description">
            {{ option.description }}
          </div>
        </div>
      </div>
      
      <!-- Content Projected Options will be processed in the component -->
      
      <div class="nxt-dropdown-no-options" *ngIf="filteredOptions.length === 0">
        <div *ngIf="currentSearchable && searchText && searchText.length >= currentMinSearchLength">
          No options found for "{{ searchText }}"
        </div>
        <div *ngIf="!currentSearchable || !searchText || searchText.length < currentMinSearchLength">
          No options available
        </div>
      </div>
    </div>

    <!-- Confirmation Footer -->
    <div class="nxt-dropdown-footer" *ngIf="currentConfirmation && currentMultiple">
      <div class="nxt-dropdown-footer-buttons">
        <button type="button" 
                class="nxt-dropdown-btn nxt-dropdown-btn-cancel"
                (click)="cancelSelection()">
          <span *ngIf="currentCancelButtonIcon" class="nxt-dropdown-btn-icon" [innerHTML]="getSanitizedIcon(currentCancelButtonIcon)"></span>
          {{ currentCancelButtonText }}
        </button>
        <button type="button" 
                class="nxt-dropdown-btn nxt-dropdown-btn-apply"
                (click)="applySelection()">
          <span *ngIf="currentApplyButtonIcon" class="nxt-dropdown-btn-icon" [innerHTML]="getSanitizedIcon(currentApplyButtonIcon)"></span>
          {{ currentApplyButtonText }}
        </button>
      </div>
    </div>
  </div>
  
  <div class="nxt-dropdown-error" *ngIf="currentRequired && !value">
    This field is required
  </div>
</div> 